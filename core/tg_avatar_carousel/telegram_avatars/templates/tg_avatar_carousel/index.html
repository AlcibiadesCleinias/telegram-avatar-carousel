<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Init Telegram Session App</title>
    <script>
      let userStageGlobal = 0;
      const DEBUG = true;

      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
      }

      async function postTelegramUser(phone, api_key, api_hash) {
          const response = await fetch(
                  "{% url 'users:telegram_user' %}",
                  {
              method: "POST",
              mode: 'cors',
              headers: { 'Content-Type': 'application/json', "X-CSRFToken": getCookie("csrftoken"),},
              body: JSON.stringify({
                phone,
                api_key,
                api_hash,
              })
            }
          );
          if (!response.ok) {
            console.log('Response is not ok', response.status)
            console.log(response.json())
            // throw new Error(message);
            return null
          }
          return response.json();
        }

      async function requestTelegramCode(phone, api_key, api_hash) {
          const response = await fetch(
                  "{% url 'users:telegram_request_code' %}",
                  {
              method: "POST",
              mode: 'cors',
              headers: { 'Content-Type': 'application/json', "X-CSRFToken": getCookie("csrftoken"),},
              body: JSON.stringify({
                phone,
                api_hash,
                api_key,
              })
            }
          );
          if (!response.ok) {
            console.log('Response is not ok', response.status)
            console.log(response.json())
            // throw new Error(message);
            return null
          }
          return response.json();
        }

      async function enterTelegramCode(code, password) {
          const response = await fetch(
                  "{% url 'users:telegram_enter_code' %}",
                  {
              method: "POST",
              mode: 'cors',
              headers: { 'Content-Type': 'application/json', "X-CSRFToken": getCookie("csrftoken"),},
              body: JSON.stringify({
                code,
                password,
              })
            }
          );
          if (!response.ok) {
            console.log('Response is not ok', response.status)
            console.log(response.json())
            // throw new Error(message);
            return null
          }
          return response.json();
        }

      const render = async () => {
        // our html frames
        let TelegramUserListViewHtml = "";
        let TelegramEnterCodeAPIViewHtml = "";
        let TelegramUserRequestCodeViewHtml = "";
        let RedirectHtml = "";

        // where we will inject out htmls above
        const target = document.querySelector("#app");

        console.log('Current stage = ', userStageGlobal)

        if (userStageGlobal === 0 || DEBUG) {
          TelegramUserListViewHtml = `
            <form onsubmit="handleTelegramUserList(event)">
              <div class="form-group">
                <label>API Key</label>
                <input type="text" class="form-control" name="api_key" aria-describedby="Telegram API KEY" placeholder="Enter telegram API key" value="">
                <small class="form-text text-muted">TODO.</small>
              </div>
              <div class="form-group">
                <label>API Hash</label>
                <input type="text" class="form-control" name="api_hash" aria-describedby="Telegram API Hash" placeholder="Enter telegram API hash" value="">
                <small class="form-text text-muted">TODO.</small>
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="text" class="form-control" name="phone" aria-describedby="Your Phone" placeholder="Enter phone (+7...)" value="">
                <small class="form-text text-muted">TODO.</small>
              </div>
              <button id="btnHandleTelegramUserListCreate" type="submit" class="btn btn-primary">Save Profile</button>
            </form>
          `;
        }

        if (userStageGlobal === 1 || DEBUG) {
          TelegramUserRequestCodeViewHtml = `
            <form onsubmit="handleTelegramUserRequestCode(event)">
              <div class="form-group">
                <label>API Key</label>
                <input type="text" class="form-control" name="api_key" aria-describedby="Telegram API KEY" placeholder="Enter telegram API key" value="">
                <small class="form-text text-muted">TODO.</small>
              </div>
              <div class="form-group">
                <label>API Hash</label>
                <input type="text" class="form-control" name="api_hash" aria-describedby="Telegram API Hash" placeholder="Enter telegram API hash" value="">
                <small class="form-text text-muted">TODO.</small>
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="text" class="form-control" name="phone" aria-describedby="Your Phone" placeholder="Enter phone (+7...)" value="">
                <small class="form-text text-muted">TODO.</small>
              </div>
              <button id="btnHandleTelegramUserRequestCode" type="submit" class="btn btn-primary">Request Code</button>
            </form>
          `;
        }

        if (userStageGlobal === 2 || DEBUG) {
          TelegramEnterCodeAPIViewHtml = `
            <form onsubmit="handleTelegramEnterCode(event)">
              <div class="form-group">
                <label>Telegram Code</label>
                <input type="password" class="form-control" name="telegram_code" aria-describedby="Telegram Code" placeholder="Enter code you received">
                <small class="form-text text-muted">TODO.</small>
              </div>
              <div class="form-group">
                <label>Telegram Password</label>
                <input type="password" class="form-control" name="telegram_password" aria-describedby="Telegram Password" placeholder="Enter your password">
                <small class="form-text text-muted">TODO.</small>
              </div>
              <button id="btnHandleTelegramEnterCode" type="submit" class="btn btn-primary">Submit</button>
            </form>
          `;
        }

        if (userStageGlobal === 2 || DEBUG) {
          RedirectHtml = `
            <div>
                <p>Now you are ready to setup images to be rotated in your account</p>
                <a class="btn btn-primary" href="{% url 'admin:index' %}" role="button">Admin Panel</a>
            </div>
          `;
        }

        target.innerHTML =
           TelegramUserListViewHtml + TelegramUserRequestCodeViewHtml + TelegramEnterCodeAPIViewHtml + RedirectHtml;
      };

      const _changeButtonTitle = (buttonId, newStatus = 'Submitting...') => {
          const _button = document.getElementById(buttonId);
          _button.disabled = true;
          _button.innerText = newStatus;
      }

      const handleTelegramUserList = async (e) => {
        e.preventDefault();

        const _api_hash = new FormData(e.target).get("api_hash");
        const _api_key = new FormData(e.target).get("api_key");
        const _phone = new FormData(e.target).get("phone");
        if (_api_hash && _api_key && _phone) {
          _changeButtonTitle('btnHandleTelegramUserListCreate', 'Submitting...');
          console.log('Post to backend...')
          const res = await postTelegramUser(_phone, _api_key, _api_hash)
          console.log('Got res', res)

          userStageGlobal += 1;
          render();
        }
      };

      const handleTelegramUserRequestCode = async (e) => {
        e.preventDefault();

        const _api_hash = new FormData(e.target).get("api_hash");
        const _api_key = new FormData(e.target).get("api_key");
        const _phone = new FormData(e.target).get("phone");
        if (_api_hash && _api_key && _phone) {
          _changeButtonTitle('btnHandleTelegramUserRequestCode', 'Requesting...');
          console.log('Post to backend...')
          const res = await requestTelegramCode(_phone, _api_key, _api_hash)
          console.log('Got res', res)

          userStageGlobal += 1;
          render();
        }
      };

      const handleTelegramEnterCode = async (e) => {
        e.preventDefault();

        const _telegram_code = new FormData(e.target).get("telegram_code");
        const _telegram_password = new FormData(e.target).get("telegram_password");
        if (_telegram_code) {
          _changeButtonTitle('btnHandleTelegramEnterCode', 'Submitting...');
          console.log('Post to backend...')
          const res = await enterTelegramCode(_telegram_code, _telegram_password)
          console.log('Got res', res)

          userStageGlobal += 1;
          render();
        }
      };
    </script>
  </head>
  <body onload="render()">
    <div id="app">
      <div class="container">Loading (awaiting MetaMask login)...</div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>
